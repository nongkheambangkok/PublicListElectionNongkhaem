<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจสอบรายชื่อผู้มีสิทธิ์เลือกตั้งล่วงหน้า - เขตหนองแขม</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-green-50 min-h-screen text-slate-800 flex flex-col justify-center">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- SECURITY CONFIGURATION ---
        // ค่าเหล่านี้จำเป็นต้องมีเพื่อใช้ถอดรหัส (แม้จะแยกไฟล์ Admin ไปแล้วก็ตาม)
        const APP_CONFIG = {
            SALT: "NongKhaem_Election_Secure_Salt_2026_#$!@", 
            ITERATIONS: 10000, 
            KEY_SIZE: 256 / 32
        };

        const generateSecureHash = (text) => {
            return CryptoJS.PBKDF2(text, APP_CONFIG.SALT, {
                keySize: APP_CONFIG.KEY_SIZE,
                iterations: APP_CONFIG.ITERATIONS
            }).toString();
        };

        // Icons
        const IconShieldCheck = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>;
        const IconSearch = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>;
        const IconAlertCircle = () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>;
        const IconCheckCircle = () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconDatabase = () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>;

        function App() {
            const [database, setDatabase] = useState([]);
            const [isDbLoaded, setIsDbLoaded] = useState(false);
            const [dbError, setDbError] = useState('');
            const [imgError, setImgError] = useState(false); // State สำหรับเช็คว่ารูปโหลดได้ไหม

            useEffect(() => {
                // โหลดไฟล์ JSON ที่สร้างจาก admin_tool.html
                fetch('data.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        setDatabase(data);
                        setIsDbLoaded(true);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        setDbError('ไม่พบฐานข้อมูล (data.json)');
                    });
            }, []);

            return (
                <div className="max-w-xl mx-auto p-4 w-full">
                    {/* Header */}
                    <div className="text-center mb-8">
                        
                        {/* ส่วนแสดงโลโก้ หรือ ไอคอน */}
                        <div className="flex justify-center mb-4">
                            {!imgError ? (
                                <img 
                                    src="image.png" 
                                    alt="ตรากรุงเทพมหานคร" 
                                    className="h-28 w-auto object-contain drop-shadow-lg hover:scale-105 transition-transform duration-300"
                                    onError={() => setImgError(true)} // ถ้ารูปเสีย ให้สลับไปใช้ไอคอนแทน
                                />
                            ) : (
                                <div className="inline-flex items-center justify-center w-20 h-20 bg-green-600 rounded-full shadow-xl text-white">
                                    <IconShieldCheck />
                                </div>
                            )}
                        </div>

                        <h1 className="text-2xl md:text-3xl font-bold text-slate-800">ตรวจสอบรายชื่อ<br/>ผู้มีสิทธิ์เลือกตั้งล่วงหน้า</h1>
                        <p className="text-green-700 mt-2 font-medium bg-green-100 inline-block px-3 py-1 rounded-full text-sm">
                            สำนักงานเขตหนองแขม 2026
                        </p>
                        
                        <div className="flex justify-center mt-3 h-6">
                            {isDbLoaded ? (
                                <span className="flex items-center gap-1 text-green-600 text-xs animate-fade-in">
                                    <IconDatabase /> พร้อมใช้งาน ({database.length})
                                </span>
                            ) : dbError ? (
                                <span className="text-red-500 text-xs animate-fade-in">{dbError}</span>
                            ) : (
                                <span className="text-slate-400 text-xs animate-pulse">กำลังโหลดข้อมูล...</span>
                            )}
                        </div>
                    </div>

                    {/* Content */}
                    <div className="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden p-6 md:p-8">
                        <VoterCheck database={database} isDbLoaded={isDbLoaded} />
                    </div>
                </div>
            );
        }

        function VoterCheck({ database, isDbLoaded }) {
            const [idCard, setIdCard] = useState('');
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleCheck = (e) => {
                e.preventDefault();
                setResult(null);
                setError('');
                if (!isDbLoaded) { setError('ระบบยังไม่พร้อมใช้งาน (ไม่พบไฟล์ข้อมูล)'); return; }

                setLoading(true);

                // Delay เพื่อให้ UI แสดงสถานะ Loading ก่อนเริ่มคำนวณหนัก
                setTimeout(() => {
                    try {
                        const cleanID = idCard.replace(/[^0-9]/g, '');
                        if (cleanID.length !== 13) {
                            setError('กรุณากรอกเลขบัตรประชาชนให้ครบ 13 หลัก');
                            setLoading(false);
                            return;
                        }

                        // คำนวณ Hash เพื่อค้นหา (ใช้ Config เดียวกับ Admin Tool)
                        const searchHash = generateSecureHash(cleanID);
                        const found = database.find(item => item.hash_id === searchHash);

                        if (found) {
                            try {
                                const bytes = CryptoJS.AES.decrypt(found.enc_name, searchHash);
                                const originalName = bytes.toString(CryptoJS.enc.Utf8);
                                if (!originalName) throw new Error("Decryption failed");
                                setResult({ ...found, decoded_name: originalName });
                            } catch (e) {
                                setError('ข้อมูลเสียหาย ไม่สามารถแสดงผลได้');
                            }
                        } else {
                            setError('ไม่พบข้อมูลผู้มีสิทธิ์ หรือ เลขบัตรไม่ถูกต้อง');
                        }
                    } catch (err) {
                        setError('เกิดข้อผิดพลาดในการประมวลผล');
                    }
                    setLoading(false);
                }, 100);
            };

            return (
                <div className="animate-fade-in">
                    <form onSubmit={handleCheck} className="space-y-5">
                        <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700 ml-1">เลขประจำตัวประชาชน</label>
                            <div className="relative">
                                <input 
                                    type="text" 
                                    value={idCard}
                                    onChange={(e) => setIdCard(e.target.value)}
                                    placeholder="ใส่เลขบัตรฯของท่านที่นี่"
                                    maxLength="13"
                                    className="w-full pl-4 pr-10 py-3.5 border border-slate-200 rounded-xl focus:ring-4 focus:ring-green-100 focus:border-green-500 outline-none font-mono text-lg transition-all text-slate-700 bg-slate-50 focus:bg-white"
                                />
                                <div className="absolute right-3 top-4 text-slate-400">
                                    <IconSearch />
                                </div>
                            </div>
                        </div>
                        
                        <button 
                            type="submit" 
                            disabled={loading || !isDbLoaded}
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3.5 rounded-xl transition-all shadow-md hover:shadow-lg disabled:opacity-50 disabled:shadow-none active:scale-[0.98]"
                        >
                            {loading ? 'กำลังตรวจสอบ...' : 'ตรวจสอบสิทธิ์'}
                        </button>
                    </form>

                    <div className="mt-8 min-h-[120px]">
                        {error && (
                            <div className="p-4 bg-red-50 border border-red-100 rounded-xl flex items-start gap-3 animate-fade-in text-red-800">
                                <div className="shrink-0 mt-0.5"><IconAlertCircle /></div>
                                <span className="text-sm font-medium">{error}</span>
                            </div>
                        )}

                        {result && (
                            <div className="bg-green-50 border border-green-200 rounded-xl p-6 animate-fade-in relative overflow-hidden">
                                <div className="absolute -top-6 -right-6 opacity-10 text-green-800">
                                    <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                                </div>
                                
                                <div className="flex items-center gap-2 mb-4 border-b border-green-200 pb-3 relative z-10">
                                    <div className="text-green-600"><IconCheckCircle /></div>
                                    <h3 className="text-lg font-bold text-green-800">มีรายชื่อผู้มีสิทธิ์</h3>
                                </div>
                                
                                <div className="grid gap-3 relative z-10">
                                    <ResultRow label="ชื่อ-นามสกุล" value={result.decoded_name} highlight />
                                    <ResultRow label="เลขบัตรฯ" value={`${idCard.substring(0,3)}-xxx-xxxxx-xx`} />
                                    <div className="grid grid-cols-2 gap-4">
                                        <ResultRow label="ชุดที่" value={result.set_no} />
                                        <ResultRow label="ลำดับที่" value={result.seq_no} />
                                    </div>
                                    <ResultRow label="หน่วยงาน/เขต" value={result.province} />
                                </div>
                            </div>
                        )}
                        
                        {!error && !result && (
                            <div className="text-center text-slate-300 text-sm py-4">
                                ผลการตรวจสอบจะแสดงที่นี่
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ResultRow({ label, value, highlight }) {
            return (
                <div>
                    <p className="text-xs text-slate-500 mb-0.5">{label}</p>
                    <p className={`font-semibold text-lg ${highlight ? 'text-green-700' : 'text-slate-800'}`}>{value}</p>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>