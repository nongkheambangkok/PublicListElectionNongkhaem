<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ตรวจสอบรายชื่อผู้มีสิทธิ์เลือกตั้งล่วงหน้า - เขตหนองแขม</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Sarabun', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-green-50 min-h-screen text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SECURITY CONFIGURATION (High Security: PBKDF2) ---
        const APP_CONFIG = {
            SALT: "NongKhaem_Election_Secure_Salt_2026_#$!@", 
            ITERATIONS: 3000, 
            KEY_SIZE: 256 / 32
        };

        const generateSecureHash = (text) => {
            return CryptoJS.PBKDF2(text, APP_CONFIG.SALT, {
                keySize: APP_CONFIG.KEY_SIZE,
                iterations: APP_CONFIG.ITERATIONS
            }).toString();
        };

        // --- ICON COMPONENTS ---
        const IconShieldCheck = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>
        );
        const IconSearch = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        );
        const IconAlertCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const IconCheckCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const IconLock = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        );
        const IconFileSpreadsheet = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>
        );
        const IconUpload = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        );
        const IconDownload = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        );
        const IconUnlock = ({ size = 24, className = "" }) => (
             <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>
        );
        const IconDatabase = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>
        );

        function App() {
            const [activeTab, setActiveTab] = useState('check');
            const [database, setDatabase] = useState([]);
            const [isDbLoaded, setIsDbLoaded] = useState(false);
            const [dbError, setDbError] = useState('');

            useEffect(() => {
                fetch('data.json')
                    .then(response => {
                        if (!response.ok) throw new Error('Network response was not ok');
                        return response.json();
                    })
                    .then(data => {
                        setDatabase(data);
                        setIsDbLoaded(true);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        setDbError('ไม่พบไฟล์ data.json หรือเกิดข้อผิดพลาดในการโหลด');
                    });
            }, []);

            return (
                <div className="max-w-3xl mx-auto p-4 md:p-8">
                    {/* Header */}
                    <div className="text-center mb-8">
                        {/* เปลี่ยนสีวงกลมโลโก้เป็นสีเขียว กทม. */}
                        <div className="inline-flex items-center justify-center w-16 h-16 bg-green-600 rounded-full mb-4 shadow-lg text-white">
                            <IconShieldCheck size={32} />
                        </div>
                        <h1 className="text-2xl md:text-3xl font-bold text-slate-800">ตรวจสอบรายชื่อผู้มีสิทธิ์เลือกตั้งล่วงหน้า</h1>
                        <p className="text-slate-600 mt-2 font-medium">สำนักงานเขตหนองแขม</p>
                        
                        <div className="flex justify-center mt-4">
                            {isDbLoaded ? (
                                <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-800 text-xs font-medium border border-green-200">
                                    <IconDatabase size={12} /> เชื่อมต่อฐานข้อมูลแล้ว ({database.length} รายการ)
                                </span>
                            ) : dbError ? (
                                <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium border border-red-200">
                                    <IconAlertCircle size={12} /> {dbError}
                                </span>
                            ) : (
                                <span className="inline-flex items-center gap-1 px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-medium border border-yellow-200">
                                    กำลังโหลดข้อมูล...
                                </span>
                            )}
                        </div>
                    </div>

                    {/* Navigation Tabs - ปรับสีเขียว */}
                    <div className="flex justify-center mb-6 border-b border-slate-200">
                        <button 
                            onClick={() => setActiveTab('check')}
                            className={`pb-2 px-6 font-medium transition-colors ${activeTab === 'check' ? 'text-green-600 border-b-2 border-green-600' : 'text-slate-400 hover:text-slate-600'}`}
                        >
                            ตรวจสอบสิทธิ์
                        </button>
                        <button 
                            onClick={() => setActiveTab('admin')}
                            className={`pb-2 px-6 font-medium transition-colors ${activeTab === 'admin' ? 'text-green-600 border-b-2 border-green-600' : 'text-slate-400 hover:text-slate-600'}`}
                        >
                            สำหรับผู้ดูแล
                        </button>
                    </div>

                    {/* Content Box */}
                    <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px]">
                        {activeTab === 'check' ? (
                            <VoterCheck database={database} isDbLoaded={isDbLoaded} />
                        ) : (
                            <AdminGenerator onDataGenerated={(newData) => {
                                setDatabase(newData);
                                setIsDbLoaded(true);
                            }} />
                        )}
                    </div>

                    {/* Footer - แก้ไขข้อความตามต้องการ */}
                    <footer className="mt-8 text-center text-sm text-slate-500 font-medium">
                        <p>สำนักงานเขตหนองแขม 2026</p>
                    </footer>
                </div>
            );
        }

        // --------------------------------------------------------
        // 1. Voter Check (User)
        // --------------------------------------------------------
        function VoterCheck({ database, isDbLoaded }) {
            const [idCard, setIdCard] = useState('');
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handleCheck = (e) => {
                e.preventDefault();
                setResult(null);
                setError('');
                if (!isDbLoaded) { setError('ไม่พบฐานข้อมูล'); return; }

                setLoading(true);

                setTimeout(() => {
                    try {
                        const cleanID = idCard.replace(/[^0-9]/g, '');
                        if (cleanID.length !== 13) {
                            setError('กรุณากรอกเลขบัตรประชาชนให้ครบ 13 หลัก');
                            setLoading(false);
                            return;
                        }

                        const searchHash = generateSecureHash(cleanID);
                        const found = database.find(item => item.hash_id === searchHash);

                        if (found) {
                            try {
                                const bytes = CryptoJS.AES.decrypt(found.enc_name, searchHash);
                                const originalName = bytes.toString(CryptoJS.enc.Utf8);
                                if (!originalName) throw new Error("Decryption failed");
                                setResult({ ...found, decoded_name: originalName });
                            } catch (e) {
                                setError('ข้อมูลเสียหาย ไม่สามารถแสดงชื่อได้');
                            }
                        } else {
                            setError('ไม่พบข้อมูลผู้มีสิทธิ์ หรือ เลขบัตรไม่ถูกต้อง');
                        }
                    } catch (err) {
                        setError('เกิดข้อผิดพลาดในการประมวลผล');
                        console.error(err);
                    }
                    setLoading(false);
                }, 100);
            };

            return (
                <div className="p-6 md:p-8 animate-fade-in">
                    <form onSubmit={handleCheck} className="space-y-4 max-w-md mx-auto">
                        <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-700">เลขประจำตัวประชาชน (13 หลัก)</label>
                            {/* ปรับสี Focus เป็นสีเขียว */}
                            <input 
                                type="text" 
                                value={idCard}
                                onChange={(e) => setIdCard(e.target.value)}
                                placeholder="ใส่เลขบัตรฯของท่านที่นี่"
                                maxLength="13"
                                className="w-full pl-4 pr-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 outline-none font-mono text-lg transition-all"
                            />
                        </div>
                        {/* ปรับปุ่มเป็นสีเขียว */}
                        <button 
                            type="submit" 
                            disabled={loading || !isDbLoaded}
                            className="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 rounded-lg transition-colors shadow-md disabled:opacity-50 flex justify-center items-center gap-2"
                        >
                            {loading ? 'กำลังคำนวณรหัสลับ...' : 'ตรวจสอบข้อมูล'}
                        </button>
                    </form>

                    <div className="mt-8">
                        {error && (
                            <div className="p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3 animate-fade-in">
                                <IconAlertCircle className="text-red-500 shrink-0" size={20} />
                                <span className="text-red-700">{error}</span>
                            </div>
                        )}

                        {result && (
                            <div className="bg-green-50 border border-green-200 rounded-lg p-6 animate-fade-in relative overflow-hidden">
                                <div className="absolute top-0 right-0 p-4 opacity-10">
                                    <IconShieldCheck size={100} className="text-green-600" />
                                </div>
                                <div className="flex items-center gap-3 mb-4 border-b border-green-200 pb-3">
                                    <IconCheckCircle className="text-green-600" size={24} />
                                    <h3 className="text-lg font-bold text-green-800">มีรายชื่อผู้มีสิทธิ์เลือกตั้ง</h3>
                                </div>
                                <div className="grid md:grid-cols-2 gap-4">
                                    {/* ปรับ Highlight เป็นสีเขียวเข้ม */}
                                    <ResultItem label="ชื่อ-นามสกุล" value={result.decoded_name} highlight />
                                    <ResultItem label="เลขบัตรประชาชน" value={`${idCard.substring(0,3)}-xxx-xxxxx-xx`} />
                                    <ResultItem label="ชุดที่" value={result.set_no} />
                                    <ResultItem label="ลำดับที่" value={result.seq_no} />
                                    <ResultItem label="เขตเลือกตั้ง" value={result.province} fullWidth />
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        function ResultItem({ label, value, highlight, fullWidth }) {
            return (
                <div className={`${fullWidth ? 'col-span-full' : ''}`}>
                    <p className="text-xs text-slate-500 mb-1">{label}</p>
                    <p className={`font-semibold text-lg ${highlight ? 'text-green-700' : 'text-slate-800'}`}>{value}</p>
                </div>
            );
        }

        // --------------------------------------------------------
        // 2. Admin Generator
        // --------------------------------------------------------
        function AdminGenerator({ onDataGenerated }) {
            const [isLocked, setIsLocked] = useState(true);
            const [passwordInput, setPasswordInput] = useState('');
            const [loginError, setLoginError] = useState('');
            const [csvInput, setCsvInput] = useState('');
            const [jsonOutput, setJsonOutput] = useState('');
            const [stats, setStats] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [progress, setProgress] = useState(0); // เพิ่ม State สำหรับเก็บ % ความคืบหน้า
            const fileInputRef = useRef(null);

            const handleLogin = (e) => {
                e.preventDefault();
                if (passwordInput === 'BMAbangkok') { setIsLocked(false); setLoginError(''); } 
                else { setLoginError('รหัสผ่านไม่ถูกต้อง'); }
            };

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => setCsvInput(evt.target.result);
                reader.readAsText(file);
            };

            const handleGenerate = async () => {
                if (!csvInput.trim()) return;
                setIsProcessing(true);
                setProgress(0);
                
                // รอให้หน้าจออัปเดตสถานะ Processing ก่อนเริ่มงานหนัก
                await new Promise(resolve => setTimeout(resolve, 50));

                const lines = csvInput.trim().split('\n');
                const totalLines = lines.length;
                const secureData = [];
                const BATCH_SIZE = 20; // ทำทีละ 20 แถว เพื่อไม่ให้หน้าจอค้าง

                for (let i = 0; i < totalLines; i += BATCH_SIZE) {
                    const chunk = lines.slice(i, i + BATCH_SIZE);
                    
                    const chunkResults = chunk.map(line => {
                        const cols = line.split(',').map(c => c.trim());
                        if(cols.length < 5) return null;
                        
                        const idCard = cols[3];
                        const fullName = cols[4];
                        if(!idCard || idCard.length < 10) return null; 

                        const secureHash = generateSecureHash(idCard);
                        const encryptedName = CryptoJS.AES.encrypt(fullName, secureHash).toString();

                        return {
                            hash_id: secureHash,
                            enc_name: encryptedName,
                            set_no: cols[0],
                            province: cols[1],
                            seq_no: cols[2]
                        };
                    }).filter(x => x !== null);

                    secureData.push(...chunkResults);

                    // อัปเดต % ความคืบหน้า
                    const currentProgress = Math.round(Math.min(((i + BATCH_SIZE) / totalLines) * 100, 100));
                    setProgress(currentProgress);

                    // พัก 0ms เพื่อคืนการทำงานให้ Main Thread (ทำให้ UI ไม่ค้าง)
                    await new Promise(resolve => setTimeout(resolve, 0));
                }

                const outputString = JSON.stringify(secureData, null, 2);
                setJsonOutput(outputString);
                setStats(secureData.length);
                onDataGenerated(secureData);
                setIsProcessing(false);
            };

            const handleDownload = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonOutput);
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "data.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            if (isLocked) {
                return (
                    <div className="flex flex-col items-center justify-center h-[400px] bg-slate-100 p-8 animate-fade-in">
                        <div className="bg-white p-8 rounded-xl shadow-md max-w-sm w-full text-center border border-slate-200">
                            <div className="mx-auto bg-slate-100 w-16 h-16 rounded-full flex items-center justify-center mb-4">
                                <IconLock size={32} className="text-slate-500" />
                            </div>
                            <h3 className="text-xl font-bold mb-2">ยืนยันตัวตนผู้ดูแลระบบ</h3>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <input 
                                    type="password" 
                                    value={passwordInput}
                                    onChange={(e) => setPasswordInput(e.target.value)}
                                    placeholder="รหัสผ่าน"
                                    className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 outline-none"
                                />
                                {loginError && <p className="text-red-500 text-xs">{loginError}</p>}
                                <button type="submit" className="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700 transition">เข้าสู่ระบบ</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="p-6 md:p-8 bg-slate-50 animate-fade-in">
                    <div className="mb-6 bg-emerald-50 border border-emerald-200 p-4 rounded-lg text-sm text-emerald-800 flex justify-between items-center">
                        <div className="font-bold flex items-center gap-2"><IconUnlock size={16} /> โซนผู้ดูแลระบบ</div>
                        <button onClick={() => setIsLocked(true)} className="text-xs text-emerald-700 underline">Lock</button>
                    </div>

                    <div className="space-y-4">
                        <div>
                            <label className="block text-sm font-semibold mb-2">1. นำเข้าข้อมูล CSV</label>
                            <div className="flex gap-2 mb-3">
                                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="px-4 py-2 bg-white border border-slate-300 rounded-lg text-sm font-medium hover:bg-slate-50 flex items-center gap-2 shadow-sm">
                                    <IconUpload size={16} /> เลือกไฟล์ CSV
                                </button>
                            </div>
                            <textarea 
                                className="w-full h-32 p-3 text-xs font-mono border rounded-lg focus:ring-2 focus:ring-green-500"
                                placeholder="1,กทม เขต1,001,1234567890123,นายสมชาย..."
                                value={csvInput}
                                onChange={(e) => setCsvInput(e.target.value)}
                            ></textarea>
                        </div>

                        {/* ปรับปุ่ม Admin เป็นโทนสีเขียวเข้ม (Emerald/Green) */}
                        <button 
                            onClick={handleGenerate}
                            disabled={isProcessing}
                            className="bg-slate-800 text-white px-4 py-2 rounded-lg hover:bg-slate-700 text-sm font-semibold flex items-center gap-2 disabled:opacity-50"
                        >
                            {isProcessing ? `กำลังคำนวณ ${progress}% (PBKDF2)...` : <><IconFileSpreadsheet size={16} /> แปลงและเข้ารหัส (Safe)</>}
                        </button>

                        {jsonOutput && (
                            <div className="animate-fade-in bg-white border rounded-lg p-4 mt-4 shadow-sm">
                                <label className="block text-sm font-bold text-slate-700 mb-2">2. ผลลัพธ์ (พร้อมดาวน์โหลด) <span className="text-green-600 ml-2 font-normal">({stats} รายการ)</span></label>
                                <div className="relative">
                                    <textarea readOnly className="w-full h-48 p-3 text-xs font-mono border rounded-lg bg-slate-100 text-slate-600" value={jsonOutput}></textarea>
                                    <button onClick={handleDownload} className="absolute top-2 right-2 bg-green-600 text-white shadow-sm px-4 py-2 rounded text-xs font-bold hover:bg-green-700 flex items-center gap-2">
                                        <IconDownload size={14} /> ดาวน์โหลด data.json
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>